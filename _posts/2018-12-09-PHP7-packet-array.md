---
layout: post
title: PHP7ä¸­çš„packed array
description: PHP7ä¸­æ•°ç»„çš„ä¸€äº›æ”¹è¿›
tags: [C, PHP, code]

comments: true
share: true
---
ä¸Šæ¬¡æåˆ°PHP7çš„æ•°ç»„åˆ†ä¸ºpacked array å’Œ hash arrayï¼ŒåŒºåˆ«åœ¨äºpacked arrayå–å€¼ä¸éœ€è¦é€šè¿‡slotè·å¾—arDataçš„ä¸‹æ ‡ï¼Œå®ƒçš„keyå¯¹åº”çš„å°±æ˜¯ä¸‹æ ‡ï¼Œæ‰€ä»¥å–å€¼é€Ÿåº¦ä¸Šæ›´æœ‰ä¼˜åŠ¿å’Œæ¯”è¾ƒçœå†…å­˜ã€‚

packed arrayè¦æ»¡è¶³çš„æ¡ä»¶æ˜¯keyå¿…é¡»æ˜¯é€’å¢çš„æ­£æ•´å‹ã€‚
{% highlight php %}
<?php
$arr = [1, 2, 3]; // æ˜¯
$arr = [ 1 => 1, 3 => 3]; // æ˜¯(è·¨ä¸‹æ ‡çš„æœ‰ä¾‹å¤–)
$arr = [-1 => 1, 0 => 2]; // ä¸æ˜¯
$arr = [2 => 1, 1 => 2]; // ä¸æ˜¯

{% endhighlight %}

<b>è½¬æ¢ä¸ºpacked arrayçš„æ“ä½œ</b>   
shuffleï¼Œarray_keysç­‰å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ zend_hash_to_packed è½¬æ¢ä¸ºpacked arrayã€‚


<b>è½¬æ¢ä¸ºhash arrayçš„æ“ä½œ</b>   
1. å¾€packed arrayæ·»åŠ string keyçš„æ“ä½œ
2. æ·»åŠ çš„keyæ˜¯æ•´å‹ä½†æ˜¯ä¹‹å‰è¿™ä¸ªkeyè¢«unsetè¿‡ï¼ˆZ_TYPE == IS_UNDEF çŠ¶æ€ï¼‰
3. æ·»åŠ çš„key å¤§äºnTableSizeï¼ˆæ•°ç»„å®¹é‡ï¼‰å¹¶ä¸” (key >> 1) > nTableSize || (nTableSize >> 1) > nNumOfElements è¿™é‡ŒğŸ˜‚å¤ªæ‹—å£æˆ‘å°±ç›´æ¥è´´ä»£ç å¥½äº†

å…³äºâ‘¡PHPæ•°ç»„unsetæ“ä½œå¹¶ä¸ä¼šç«‹é©¬åˆ é™¤æŒ‡å®šçš„bucketï¼Œè€Œä¸”æŠŠå®ƒæ ‡è¯†ä¸º`IS_UNDEF`çš„çŠ¶æ€ï¼Œç­‰å¾…rehashæˆ–è€…æ‰©å®¹çš„æ—¶å€™å†å¤„ç†ï¼ˆè¿™æ˜¯åè¯ï¼Œæœ‰æœºä¼šå†å¡«å‘å§ï¼‰ã€‚  
æ¯”å¦‚æœ‰ä¸€ä¸ªpacked array 
{% highlight php %}
<?php
$arr = [1, 2, 3];
unset($arr[1]);
$arr[1] = 4; 
// output
$arr == [0 => 1, 2 => 3, 1 => 4]
{% endhighlight %}
è¿™æ—¶å€™å°±å·²ç»è½¬åŒ–æˆäº†hash array

å…³äºâ‘¢å…ˆè¦å„ä¸ªå­—æ®µä¹‹é—´çš„å…³ç³»æ˜¯ï¼Œæ•°ç»„å®¹é‡(nTableSizeï¼Œåˆå§‹åŒ–æ•°ç»„å®¹é‡æ˜¯8) = å·²ä½¿ç”¨(nNumUsed) + æœªä½¿ç”¨ï¼Œ å·²ä½¿ç”¨(nNumUsed) = æœ‰æ•ˆ(nNumOfElementsï¼Œæˆ‘ä»¬countæ•°ç»„å¾—åˆ°çš„å°±æ˜¯è¿™ä¸ªå¤§å°) + æ— æ•ˆ(unsetçš„) ã€‚ç»“åˆä¸Šé¢çš„æè¿°å¾—åˆ° $arr = [0 => 1, 8 => 2]; æ˜¯ä¸€ä¸ªhash arrayã€‚

![](//i.loli.net/2019/05/05/5cce45be335b7.jpg)

æ‰“å°å‡ºè¿™æ—¶å€™çš„HashTableå¯ä»¥çœ‹åˆ°ï¼Œu.flag = 26 & HASH_FLAG_PACKED(4) == 0 å·²ç»ä¸æ˜¯packed arrayäº†ï¼Œè™½ç„¶æˆ‘ä»¬ç¬¬äºŒä¸ªå…ƒç´ ä¸‹æ ‡æ˜¯8è¶…è¿‡äº†å®¹é‡nTableSizeï¼Œä½†æ˜¯è¿™æ—¶å€™å¹¶æ²¡æœ‰æ‰©å®¹ï¼Œè€Œæ˜¯è½¬ä¸ºhash arrayä½¿å¾—å†…å­˜ä½¿ç”¨è¾¹å¾—æ›´ç´§å‡‘ã€‚

å‚è€ƒï¼š
* ã€ŠPHP 7åº•å±‚è®¾è®¡ä¸æºç å®ç°ã€‹
* PHP7.2-SRC
* nikic åšå®¢