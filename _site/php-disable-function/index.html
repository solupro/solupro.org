<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>PHP - 使disable_function支持通配符 &#8211; Solu's 记事簿</title>
<meta name="description" content="通过extension使disable_function支持通配符">
<meta name="keywords" content="C, PHP, code">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP - 使disable_function支持通配符">
<meta property="og:description" content="通过extension使disable_function支持通配符">
<meta property="og:url" content="https://solupro.org/php-disable-function/">
<meta property="og:site_name" content="Solu's 记事簿">

<meta name="google-site-verification" content="solupro.org">



<link rel="canonical" href="https://solupro.org/php-disable-function/">
<link href="https://solupro.org/feed.xml" type="application/atom+xml" rel="alternate" title="Solu's 记事簿 Feed">
<link rel="author" href="https://plus.google.com/+solu_scarlet?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://solupro.org/assets/css/main.min.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://solupro.org/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://solupro.org/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://solupro.org/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://solupro.org/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://solupro.org/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://solupro.org/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://solupro.org/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://solupro.org">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://solupro.org/images/avatar.png" alt="Solu Scarlet photo" class="author-photo">
					<h4>Solu Scarlet</h4>
					<p>PHP程序猿，Python爱好者，C语言初心者 同时是一个伪宅男，二小姐本命什么的我会随便说吗!</p>
				</li>
				<li><a href="https://solupro.org/about/">Learn More</a></li>
				<li>
					<a href="mailto:sendsoluex@gmail.com"><i class="icon-envelope"></i> Email</a>
				</li>
				
				
				<li>
					<a href="https://plus.google.com/+solu_scarlet"><i class="icon-google-plus"></i> Google+</a>
				</li>
				
				<li>
					<a href="http://github.com/https://github.com/solupro"><i class="icon-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://solupro.org/posts/">All Posts</a></li>
				<li><a href="https://solupro.org/tags/">All Tags</a></li>
			</ul>
		</li>
		<li>
			<a href="#">Links</a>
			<ul class="dl-submenu">
				
				<li>
					
					<a href="http://blog.kochiya.me/"  target="_blank"  >Sanaeの空想庭园</a>
					
				</li>
				
				<li>
					
					<a href="http://www.migroom.com/"  target="_blank"  >思安阁</a>
					
				</li>
				
			</ul>
		</li>
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="https://solupro.org/php-disable-function/" rel="bookmark" title="PHP - 使disable_function支持通配符">PHP - 使disable_function支持通配符</a></h1>
        
        <h2>February 04, 2013</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>很久很久以前，翻<code>php.ini</code>的时候看到了一堆“同族”的函数</p>

<blockquote>
  <p>; This directive allows you to disable certain functions for security reasons.
; It receives a comma-delimited list of function names. This directive is
; <em>NOT</em> affected by whether Safe Mode is turned On or Off.
; http://php.net/disable-functions
disable_functions = pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,
pcntl_wifstopped,pcntl_wifsignaled,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,
pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,
pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority</p>
</blockquote>

<p>当时就想要是支持通配符那么直接写成<code>pcntl_*</code>这样就简便多了。想法是有了，但是不知道怎么实现好。偶然的机会看到了《<a href="http://www.80vul.com/webzine_0x05/0x07%20%E6%B5%85%E8%B0%88%E4%BB%8EPHP%E5%86%85%E6%A0%B8%E5%B1%82%E9%9D%A2%E9%98%B2%E8%8C%83PHP%20WebShell.html">浅谈从PHP内核层面防范PHP WebShell</a>》这文章，当中提到<code>zend_disable_function</code>这个函数，于是感觉先前的通配符想法可以实现了。</p>

<p>说一下简单的思路吧：在<code>php.ini</code>读取配置，遍历函数表，正则匹配函数然后删除掉，注册一个同名函数以便给前端提示。</p>

<!-- more -->

<p>先用C模拟一下实现吧，代码如下</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pcre.h&gt;</span><span class="cp"></span>

<span class="cp">#define OVERCCOUNT 30</span>
<span class="cp">#define MAX_REGEX_COUNT 50 </span><span class="c1">//最大支持规则数量</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">replace_start</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//替换通配符*号</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">orig</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">rep</span> <span class="o">=</span> <span class="s">&quot;(</span><span class="se">\\</span><span class="s">w+)&quot;</span><span class="p">;</span>
    
    <span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">);</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">orig</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="s">&quot;$&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s%s%s&quot;</span><span class="p">,</span> <span class="s">&quot;^&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="s">&quot;$&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">orig</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="n">str</span><span class="p">);</span> <span class="c1">// Copy characters from &#39;str&#39; start to &#39;orig&#39; st$</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">p</span><span class="o">-</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">str</span><span class="p">),</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">rep</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">orig</span><span class="p">));</span>
    <span class="n">free</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matchpattern</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pcre</span> <span class="o">*</span><span class="n">re</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">erroffset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ovector</span><span class="p">[</span><span class="n">OVERCCOUNT</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">re</span> <span class="o">=</span> <span class="n">pcre_compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">PCRE_CASELESS</span><span class="o">|</span><span class="n">PCRE_DOTALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">erroffset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">re</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">pcre_exec</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ovector</span><span class="p">,</span> <span class="n">OVERCCOUNT</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">re</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">function_table</span><span class="p">[]</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s">&quot;array_diff&quot;</span><span class="p">,</span> <span class="s">&quot;array_pop&quot;</span><span class="p">,</span> <span class="s">&quot;array_shift&quot;</span><span class="p">,</span> <span class="s">&quot;var_dump&quot;</span><span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">,</span> \
         <span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="s">&quot;str_replace&quot;</span><span class="p">,</span> <span class="s">&quot;strstr&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;abc_str&quot;</span><span class="p">};</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ini</span> <span class="o">=</span> <span class="s">&quot;array_*, *str test&quot;</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span><span class="c1">//这里支持,号和空格来分割规则</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">regex_list</span><span class="p">[</span><span class="n">MAX_REGEX_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ini</span><span class="p">));</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">replace_start</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
            <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">strndup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">delim</span><span class="p">)));</span>
    <span class="p">}</span>
   
    <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">regex</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">function_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_REGEX_COUNT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">regex_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regex</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
            <span class="c1">//printf(&quot;regex:%s\n&quot;, regex);</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">matchpattern</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">regex</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;function:%s() are disabled!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
   
    <span class="c1">//free memory</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REGEX_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">regex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">free</span><span class="p">(</span><span class="n">regex</span><span class="p">);</span>
            <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">free</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    
<span class="p">}</span></code></pre></figure>

<p>因为要使用正则，我在这里选择了<code>pcre</code>库，于是我们编译的时候要带上<code>-lpcre</code>。运行看看我们的效果。
<img src="http://static.oschina.net/uploads/space/2013/0204/115147_uZQT_111529.png" alt="" />
嗯，好像还不错的样子。接下来就是关键了，怎么改编成PHP扩展</p>

<p>至于怎么快速创建一个PHP扩展的就不介绍了，可以参考《<a href="http://blog.csdn.net/heiyeshuwu/article/details/3453854">快速开发一个PHP扩展</a>》，我在这里新建了一个叫<code>solutest</code>的扩展。接着我们把上面的函数（main函数对应的改一下名字，我这里改为 static void remove_function()）贴到<code>solutest.c</code>（文件名对应你创建时候输入的名字）里面，对应的内存操作函数可以换成由php内核提供的e<em>系列函数，malloc-&gt;emalloc, free-&gt;efree …还有一点是用e</em>系列申请的内存才用<code>efree</code>来释放，囧在这里吃过亏。（详细参考《PHP扩展开发与内核应用》- <a href="http://www.walu.cc/phpbook/3.1.md">内存管理</a>）。然后在 <code>PHP_MINIT_FUNCTION</code> 里面调用我们的 <code>remove_function</code>，为什么选择 PHP_MINIT_FUNCTION ？或者你可以尝试在 <code>PHP_RINIT_FUNCTION</code> 调用 （参考《PHP扩展开发与内核应用》- <a href="http://www.walu.cc/phpbook/1.2.md">PHP启动与终结</a>）。编译看看效果，别忘了需要<code>pcre</code>库的支持，所以要加上 pcre.h 后，然后编辑 Makefile 在EXTRA_LIBS 加上 <code>-lpcre</code>。</p>

<p>OK，make &amp;&amp; sudo make install，接着编辑<code>php.ini</code>加上我们的扩展（我测试环境是nginx + php-fpm,对应php.ini在 /etc/php5/fpm/php.ini，如果不确定你加载的配置文件路径可以查看phpinfo的Loaded Configuration File）</p>

<blockquote>
  <p>[solutest] <br />
extension=solutest.so</p>
</blockquote>

<p><code>sudo /etc/init.d/php5-fpm restart </code><br />
我们重启fpm看看效果(如果apache环境直接重启apache服务器即可)
<img src="http://static.oschina.net/uploads/space/2013/0204/151750_Nt7k_111529.png" alt="" />
嗯～跑起来了。</p>

<p>怎么获取系统的函数呢？我们可以参考一下<code>zend_disable_function</code>的实现</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="c1">//file:&quot;Zend/zend_API.c&quot; line:2524</span>
<span class="n">ZEND_API</span> <span class="kt">int</span> <span class="nf">zend_disable_function</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">function_name</span><span class="p">,</span> <span class="n">uint</span> <span class="n">function_name_length</span> <span class="n">TSRMLS_DC</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zend_hash_del</span><span class="p">(</span><span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">),</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_name_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disabled_function</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fname</span> <span class="o">=</span> <span class="n">function_name</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">zend_register_functions</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">disabled_function</span><span class="p">,</span> <span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">),</span> <span class="n">MODULE_PERSISTENT</span> <span class="n">TSRMLS_CC</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>嗯，从函数我们可以知道<code>CG(function_table)</code>保存了我们要的函数表，而且它是一个 HashTable 结构，我们可以通过 <code>zend_hash_del</code> 删除函数表内某个函数。跟进去 <code>zend_hash_del</code>函数看看</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="c1">//file:&quot;Zend/zend_hash.h&quot; line:154</span>
<span class="cp">#define zend_hash_del(ht, arKey, nKeyLength) \</span>
<span class="cp">		zend_hash_del_key_or_index(ht, arKey, nKeyLength, 0, HASH_DEL_KEY)</span></code></pre></figure>

<p>是一个宏，继续展开深入在 <code>file:"Zend/zend_hash.c" line:486</code>，函数有点就不贴了，可以看出是对HashTable的遍历和一些链表删除的操作，还有得到一个重要信息是函数名保存在了<code>Bucket</code>的<code>arKey</code>。以下是HashTbale的定义</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="c1">//file:&quot;Zend/zend_hash.h&quot; line:52</span>
<span class="k">struct</span> <span class="n">_hashtable</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">bucket</span> <span class="p">{</span>
	<span class="n">ulong</span> <span class="n">h</span><span class="p">;</span>						<span class="cm">/* Used for numeric indexing */</span>
	<span class="n">uint</span> <span class="n">nKeyLength</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pDataPtr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bucket</span> <span class="o">*</span><span class="n">pListNext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bucket</span> <span class="o">*</span><span class="n">pListLast</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bucket</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bucket</span> <span class="o">*</span><span class="n">pLast</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arKey</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Bucket</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_hashtable</span> <span class="p">{</span>
	<span class="n">uint</span> <span class="n">nTableSize</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">nTableMask</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">nNumOfElements</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">nNextFreeElement</span><span class="p">;</span>
	<span class="n">Bucket</span> <span class="o">*</span><span class="n">pInternalPointer</span><span class="p">;</span>	<span class="cm">/* Used for element traversal */</span>
	<span class="n">Bucket</span> <span class="o">*</span><span class="n">pListHead</span><span class="p">;</span>
	<span class="n">Bucket</span> <span class="o">*</span><span class="n">pListTail</span><span class="p">;</span>
	<span class="n">Bucket</span> <span class="o">**</span><span class="n">arBuckets</span><span class="p">;</span>
	<span class="n">dtor_func_t</span> <span class="n">pDestructor</span><span class="p">;</span>
	<span class="n">zend_bool</span> <span class="n">persistent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nApplyCount</span><span class="p">;</span>
	<span class="n">zend_bool</span> <span class="n">bApplyProtection</span><span class="p">;</span>
<span class="cp">#if ZEND_DEBUG</span>
	<span class="kt">int</span> <span class="n">inconsistent</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">HashTable</span><span class="p">;</span></code></pre></figure>

<p>详细的解释可以参考《深入理解PHP内核》- <a href="http://www.php-internal.com/book/?p=chapt03/03-01-02-hashtable-in-php">PHP哈希表实现</a></p>

<p>好吧，依葫芦画瓢，尝试遍历一下<code>function_table</code>。把 <code>remove_function</code>函数对应修改为</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_function</span><span class="p">()</span> <span class="p">{</span>
<span class="cp">#ifdef ZEND_SIGNALS</span>
    <span class="n">TSRMLS_FETCH</span><span class="p">();</span>
<span class="cp">#endif</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">ini</span> <span class="o">=</span> <span class="s">&quot;array_*, *str test&quot;</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span><span class="c1">//这里支持,号和空格来分割规则</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">regex_list</span><span class="p">[</span><span class="n">MAX_REGEX_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">estrndup</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ini</span><span class="p">));</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="c1">//p = replace_str(p, &quot;*&quot;, &quot;(\\w+)&quot;);</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">replace_start</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
            <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">estrndup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">delim</span><span class="p">)));</span>
    <span class="p">}</span>
   
    <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">regex</span><span class="p">;</span>
    <span class="n">HashTable</span> <span class="n">ht_func</span><span class="p">,</span> <span class="o">*</span><span class="n">pht_func</span><span class="p">;</span>
    <span class="n">Bucket</span> <span class="o">*</span><span class="n">pBk</span><span class="p">;</span>
    <span class="c1">//拷贝一份CG(function_table)进行操作</span>
    <span class="n">zend_hash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_func</span><span class="p">,</span> <span class="n">zend_hash_num_elements</span><span class="p">(</span><span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">)),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">zend_hash_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_func</span><span class="p">,</span> <span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zval</span><span class="o">*</span><span class="p">));</span>
    <span class="n">pht_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ht_func</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">pBk</span> <span class="o">=</span> <span class="n">pht_func</span><span class="o">-&gt;</span><span class="n">pListHead</span><span class="p">;</span> <span class="n">pBk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pBk</span> <span class="o">=</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">pListNext</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//free memory</span>
    <span class="n">zend_hash_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_func</span><span class="p">);</span> <span class="c1">//销毁HashTable</span>
    <span class="n">pht_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REGEX_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">regex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">efree</span><span class="p">(</span><span class="n">regex</span><span class="p">);</span>
            <span class="n">regex_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">efree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>   
<span class="p">}</span></code></pre></figure>

<p>保存以后又是一轮的  make &amp;&amp; sudo make install。sudo /etc/init.d/php5-fpm restart，刷啦啦的一大片，吓坏了吧，保存下来看看有多少。
<img src="http://static.oschina.net/uploads/space/2013/0204/160012_pMwU_111529.png" alt="" />
应该差不多了吧，后面有…省略号是不是buffer什么的满了所以还没输出完呢？？？</p>

<p>OK，下面是重点了，删除对应的函数。其实我们抄一下<code>zend_disable_function</code>就OK了，有同学会问为什么不直接调用<code>zend_disable_function</code>，别急，下面我会说道。再次修改我们的<code>remove_function</code>函数，这次修改便利的循环体和 <code>char *ini</code> 就好</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="kt">char</span> <span class="o">*</span><span class="n">ini</span> <span class="o">=</span> <span class="s">&quot;array_p*,&quot;</span><span class="p">;</span> <span class="c1">//使用array族函数测试</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="k">for</span> <span class="p">(</span><span class="n">pBk</span> <span class="o">=</span> <span class="n">pht_func</span><span class="o">-&gt;</span><span class="n">pListHead</span><span class="p">;</span> <span class="n">pBk</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pBk</span> <span class="o">=</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">pListNext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_REGEX_COUNT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">regex_list</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regex</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="c1">//regex = &quot;^array_p(\\w+)&quot;;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">matchpattern</span><span class="p">(</span><span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">,</span> <span class="n">regex</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;function:%s are disabled!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">);</span>
            <span class="c1">//zend_disable_function(func, sizeof(func));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">zend_hash_del</span><span class="p">(</span><span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">),</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;disable %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="n">disabled_function</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fname</span> <span class="o">=</span> <span class="n">pBk</span><span class="o">-&gt;</span><span class="n">arKey</span><span class="p">;</span>
            <span class="n">zend_register_functions</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">disabled_function</span><span class="p">,</span> <span class="n">CG</span><span class="p">(</span><span class="n">function_table</span><span class="p">),</span> <span class="n">MODULE_PERSISTENT</span> <span class="n">TSRMLS_CC</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>因为把系统的函数删除了，不知请者调用会产生一个php函数不存在的错误，脚本也会停止运行，于是需要注册一个同名的函数回去，而这个函数什么也不做，输出提示就好。那么我们需要在 <code>remove_function</code> 函数之前定义函数入口和提示函数</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">print_disabed_info</span><span class="p">)</span>
<span class="p">{</span>  
    <span class="c1">//I don&#39;t know why I can&#39;t use get_active_function_name in here</span>
    <span class="c1">// Maybe &quot;EG&quot;</span>
    <span class="n">zend_error</span><span class="p">(</span><span class="n">E_WARNING</span><span class="p">,</span> <span class="s">&quot;*** function has been disabled! (°Д°≡°д°)ｴｯ!?&quot;</span><span class="p">);</span> <span class="c1">//get_active_function_name(TSRMLS_C)</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">zend_function_entry</span> <span class="n">disabled_function</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PHP_FALIAS</span><span class="p">(</span><span class="n">display_disabled_function</span><span class="p">,</span> <span class="n">print_disabed_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">PHP_FE_END</span>
<span class="p">};</span></code></pre></figure>

<p>估计有同学吐槽为什么用***代替了显示的函数名，这就是为什么我不调用<code>zend_disable_function</code>的原因。当时卡在这里很久，一直段错误，后来无意中注释了 get_active_function_name(TSRMLS_C) 就跑起来了╯-__-)╯ ╩╩，求告知(2014-05-12 update 问题已解决，下面会给出代码地址)。。和上面一个编译重启服务器什么的，然后看效果，因为我们配置写的是<code>array_p*</code>，所以一下函数被禁用了。（测试完以后记得关闭输出）
<img src="http://static.oschina.net/uploads/space/2013/0204/162346_lRR8_111529.png" alt="" /></p>

<p>然后随便写个脚本，调用一下array_pop函数什么的，然后执行之。
<img src="http://static.oschina.net/uploads/space/2013/0204/162548_I77d_111529.png" alt="" /></p>

<p>It’s work!! :)</p>

<p>呼，不知不觉写了这么长了，也懒得分两篇了。接下来把读取<code>php.ini</code>配置代码写上就完成了。其实这部分工作在扩展自动生成的代码已经有了，只要稍微加工一下就好。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cm">/* </span>
<span class="cm">  	Declare any global variables you may need between the BEGIN</span>
<span class="cm">	and END macros here:     </span>
<span class="cm">*/</span>
<span class="n">ZEND_BEGIN_MODULE_GLOBALS</span><span class="p">(</span><span class="n">solutest</span><span class="p">)</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">disable_functions</span><span class="p">;</span>
<span class="n">ZEND_END_MODULE_GLOBALS</span><span class="p">(</span><span class="n">solutest</span><span class="p">)</span></code></pre></figure>

<p><code>php_solutest.h</code> 大概47行左右的样子，去掉注释加入我们的<code>disable_functions</code>变量</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cm">/* If you declare any globals in php_solutest.h uncomment this:*/</span>
<span class="n">ZEND_DECLARE_MODULE_GLOBALS</span><span class="p">(</span><span class="n">solutest</span><span class="p">)</span></code></pre></figure>

<p><code>solutest.c</code>30行左右，去掉注释</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cm">/* Remove comments and fill if you need to have entries in php.ini*/</span>
<span class="n">PHP_INI_BEGIN</span><span class="p">()</span>
    <span class="n">STD_PHP_INI_ENTRY</span><span class="p">(</span><span class="s">&quot;solutest.disable_functions&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PHP_INI_ALL</span><span class="p">,</span> <span class="n">OnUpdateString</span><span class="p">,</span> <span class="n">disable_functions</span><span class="p">,</span> <span class="n">zend_solutest_globals</span><span class="p">,</span> <span class="n">solutest_globals</span><span class="p">)</span>
<span class="n">PHP_INI_END</span><span class="p">()</span></code></pre></figure>

<p><code>solutest.c</code> 71行左右，去掉注释，修改为我们的变量</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cm">/* If you have INI entries, uncomment these lines */</span>
<span class="n">REGISTER_INI_ENTRIES</span><span class="p">();</span></code></pre></figure>

<p><code>PHP_MINIT_FUNCTION</code>函数里面，去掉注释</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cm">/* Remove comments if you have entries in php.ini */</span>
<span class="n">DISPLAY_INI_ENTRIES</span><span class="p">();</span></code></pre></figure>

<p><code>PHP_MINFO_FUNCTION</code> 函数里面，去掉注释</p>

<p>然后编辑你的<code>php.ini</code>文件，加入配置</p>

<blockquote>
  <p>[solutest]<br />
extension=solutest.so<br />
solutest.disable_functions = array_p*,</p>
</blockquote>

<p>编译重启服务器，然后浏览<code>phpinfo</code>会发现我们的配置已经被读取了。
<img src="http://static.oschina.net/uploads/space/2013/0204/165144_uZ1e_111529.png" alt="" /></p>

<p>最后把我们的配置利用上，可以通过<code>SOLUEXT_G(disable_functions)</code>宏来访问，对应修改 <code>remove_function</code> 函数。去掉 <code>char *ini</code> 因为已经不需要了，配置从<code>php.ini</code> 读取，然后修改 s</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">estrndup</span><span class="p">(</span><span class="n">SOLUTEST_G</span><span class="p">(</span><span class="n">disable_functions</span><span class="p">),</span> <span class="n">strlen</span><span class="p">(</span><span class="n">SOLUTEST_G</span><span class="p">(</span><span class="n">disable_functions</span><span class="p">)));</span></code></pre></figure>

<p>OK，保存编译重启服务器测试。
<img src="http://static.oschina.net/uploads/space/2013/0204/170137_r1sY_111529.png" alt="" /></p>

<p>:)预期的效果达到了。打完收工。</p>

<p>PS:此扩展是本人YY的产物，没有经过严格测试，请勿在生产机上使用。</p>

<p>Github: <a href="https://github.com/solupro/rdfunc">https://github.com/solupro/rdfunc</a></p>

<h2 id="参考资料">###参考资料：</h2>
<ul>
  <li>《<a href="http://www.80vul.com/webzine_0x05/0x07%20%E6%B5%85%E8%B0%88%E4%BB%8EPHP%E5%86%85%E6%A0%B8%E5%B1%82%E9%9D%A2%E9%98%B2%E8%8C%83PHP%20WebShell.html">浅谈从PHP内核层面防范PHP WebShell</a>》</li>
  <li>《<a href="http://www.walu.cc/phpbook/index.md">PHP扩展开发及内核应用</a>》</li>
  <li>《<a href="http://www.laruence.com/">鸟哥博客</a>》</li>
  <li>《<a href="http://blog.csdn.net/heiyeshuwu/article/details/3453854">快速开发一个PHP扩展</a>》</li>
  <li>《<a href="http://www.php-internal.com/">深入理解PHP内核</a>》</li>
</ul>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://solupro.org/tags/#C" title="Pages tagged C" class="tag">C</a><a href="https://solupro.org/tags/#PHP" title="Pages tagged PHP" class="tag">PHP</a><a href="https://solupro.org/tags/#code" title="Pages tagged code" class="tag">code</a></span>
        <span><a href="https://solupro.org/php-disable-function/" rel="bookmark" title="PHP - 使disable_function支持通配符">PHP - 使disable_function支持通配符</a> was published on <span class="entry-date date published updated"><time datetime="2013-02-04T00:00:00+08:00">February 04, 2013</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="https://solupro.org/about/" title="About Solu Scarlet">Solu Scarlet</a></span></span>
        <div class="social-share">
          <ul class="socialcount socialcount-small inline-list">
            <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://solupro.org/php-disable-function/" title="Share on Facebook"><span class="count"><i class="icon-facebook-sign"></i> Like</span></a></li>
            <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://solupro.org/php-disable-function/" title="Share on Twitter"><span class="count"><i class="icon-twitter-sign"></i> Tweet</span></a></li>
            <li class="googleplus"><a href="https://plus.google.com/share?url=https://solupro.org/php-disable-function/" title="Share on Google Plus"><span class="count"><i class="icon-google-plus-sign"></i> +1</span></a></li>
          </ul>
        </div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="https://solupro.org/python-get-imei-info/" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="https://solupro.org/PHP7-something-about-array/" title="PHP7中数组的一些改进">PHP7中数组的一些改进</a></h3>
          <p>PHP7中数组的一些改进 <a href="https://solupro.org/PHP7-something-about-array/">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="https://solupro.org/PHP__compare_maigc_method/" title="PHP __compare 魔术方法的实现">PHP __compare 魔术方法的实现</a></h4>
            <span>Published on May 14, 2014</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="https://solupro.org/php-two-array-function/" title="PHP 实用的两个array函数">PHP 实用的两个array函数</a></h4>
            <span>Published on May 12, 2014</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Solu Scarlet. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://solupro.org/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://solupro.org/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41773558-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'solupro'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type='text/javascript'>window._ty_rum||function(){function sf(t){switch(typeof t){case"object":if(!t)return"null";if(t instanceof Array){for(var r="[",e=0;e<t.length;e++)r+=(e>0?",":"")+sf(t[e]);return r+"]"}var r="{",e=0;for(var n in t)"function"!=typeof t[n]&&(r+=(e>0?",":"")+sf(n)+":"+sf(t[n]),e++);return r+"}";case"string":return'"'+t.replace(/([\"\\])/g,"\\$1")+'"';case"number":return t.toString();case"boolean":return t?"true":"false";case"function":return"[function]";case"undefined":default:return"undefined"}}function now(){return Date.now?Date.now():(new Date).valueOf()}function enc(t){return wd.encodeURIComponent?encodeURIComponent(t):t}function hrs(t){return function(){}}function odl(){mc.ied()}function och(){"complete"===dc.readyState&&mc.ied()}function owl(t){function r(){mc.sd()}return ty_rum.load_time?!0:(mc.ied(),ty_rum.load_time=now(),void(9===t?r():setTimeout(r,0)))}function owu(){ul||owl(9),ul=1}function ot(){mc.touch||(mc.touch=now())}function oe(t){var r=arguments,e="unknown",n=[now()];if(0!=r.length){if("string"==typeof t){var a=r.length<4?r.length:4;n[1]=r[0],a>2&&(n[2]=r[2],n[3]=0,n[4]=r[1]),a>3&&r[3]&&(n[3]=r[3])}else if(t instanceof Event&&(n[1]=t.message||(t.error&&t.error.constructor.name)+(t.error&&t.error.message)||"",n[2]=t.lineno?t.lineno:0,n[3]=t.colno?t.colno:0,n[4]=t.filename||t.error&&t.error.fileName||t.target&&t.target.baseURI||"",n[4]==dc.URL&&(n[4]="#"),n[1]===e&&n[4]===e))return;mc.e.push(n)}}function thiscall(o,m,a){for(var f="o."+m+"(",i=0;i<a.length;i++)f+=(i>0?",":"")+"a["+i+"]";return f+=");",eval(f)}function wp_open(t){return function(){var r=arguments,e=this;if(!e._ty_wrap){var n=ut.ag.apply(e,r);e._ty_rum={method:n[0],url:n[1],start:now()}}try{return t.apply(e,r)}catch(a){return e.open=t,thiscall(e,"open",r)}}}function sz(t){return"string"==typeof t?t.length:ArrayBuffer&&t instanceof ArrayBuffer?t.byteLength:Blob&&t instanceof Blob?t.size:t.length?t.length:0}function wp_send(t){return function(){function r(t){var r,e,a=i._ty_rum;if(a){if(4!==a.readyState&&(a.end=now()),a.s=i.status,a.res=sz(i.responseText),a.readyState=i.readyState,a.cb_time=s,r=[a.method+" "+a.url,a.s>0?a.end-a.start:0,s,a.s,a.s>0?0:t,a.res,a.req],a.r&&(e=n(i),e&&(e=e.xData)&&(r.push(e.id),r.push(e.action),r.push(e.time&&e.time.duration),r.push(e.time&&e.time.qu))),ty_rum.aa.push(r),ty_rum.server.custom_urls&&ty_rum.server.custom_urls.length&&!mc.ct){if(!ty_rum.pattern){ty_rum.pattern=[];for(var o=0;o<ty_rum.server.custom_urls.length;o++)ty_rum.pattern.push(new RegExp(ty_rum.server.custom_urls[o]))}for(var o=0;o<ty_rum.pattern.length;o++)if(a.url.match(ty_rum.pattern[o])){mc.ct=a.end+s;break}}mc.sa(),i._ty_rum=null}}function e(){4==i.readyState&&r(0)}function n(t){var r;if(t.getResponseHeader){var e=ut.pj(t.getResponseHeader("X-Tingyun-Tx-Data"));e&&e.r&&t._ty_rum&&e.r+""==t._ty_rum.r+""&&(r={name:t._ty_rum.url,xData:e},pf&&wd._ty_rum.c_ra.push(r))}return r}function a(t){return function(){var r;4==i.readyState&&i._ty_rum&&(i._ty_rum.end=r=now(),i._ty_rum.readyState=4);var n=t.apply(this,arguments);return 4==i.readyState&&(s=now()-r),e(),n}}function o(t){return function(){var e=i._ty_rum;return e?"progress"==t?!0:("abort"==t?r(905):"loadstart"==t?e.start=now():"error"==t?r(990):"timeout"==t&&r(903),!0):!0}}function u(t,r){r instanceof Array||(r=[r]);for(var e=0;e<r.length;e++){var n=r[e];ut.sh(t,n,o(n),!1)}}if(!this._ty_wrap){this._ty_rum.start=now(),this._ty_rum.req=arguments[0]?sz(arguments[0]):0;var i=this,s=0,c=ut.wp(!1,this,"onreadystatechange",a);c||ut.sh(this,"readystatechange",e,!1),u(this,["error","progress","abort","load","loadstart","loadend","timeout"]),c||setTimeout(function(){ut.wp(!1,i,"onreadystatechange",a)},0)}var m=function(){function t(t){var r={},e=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?/.exec(t);return e&&(r.protocol=e[1]?e[1]+":":"http:",r.hostname=e[3],r.port=e[4]||""),r}return function(r){var e=location;if(r=ut.trim(r)){if(r=r.toLowerCase(),r.startsWith("//")&&(r=e.protocol+r),!r.startsWith("http"))return!0;var n=t(r),a=n.protocol===e.protocol&&n.hostname===e.hostname;return a&&(a=n.port===e.port?!0:!e.port&&("http:"===e.protocol&&"80"===n.port||"https:"===e.protocol&&"443"===n.port)),a}return!1}}(),d=arguments;try{try{var f=ty_rum.server;f&&f.id&&this._ty_rum&&m(this._ty_rum.url)&&(this._ty_rum.r=(new Date).getTime()%1e8,this.setRequestHeader&&this.setRequestHeader("X-Tingyun-Id",f.id+";r="+this._ty_rum.r))}catch(l){}return t.apply(this,d)}catch(l){return this.send=t,thiscall(this,"send",d)}}}var wd=window,xr=wd.XMLHttpRequest,dc=document,ty_rum=wd._ty_rum={st:now(),ra:[],c_ra:[],aa:[],snd_du:function(){return this.server.adu?1e3*this.server.adu:1e4},cc:function(){return this.server.ac?this.server.ac:10}};ty_rum.server = {id:'FWeYcFKtxr4',beacon:'beacon.tingyun.com',beacon_err:'beacon-err.tingyun.com',key:'TFTB2d8fx0A',trace_threshold:40000,custom_urls:[],sr:1.0};if(ty_rum.server&&!(ty_rum.server.sr&&Math.random()>=ty_rum.server.sr)){var trim=String.prototype.trim;String.prototype.startsWith||(String.prototype.startsWith=function(t,r){return r=r||0,this.indexOf(t,r)===r});var ut={wp:function(t,r,e,n,a){var o;try{o=r[e]}catch(u){if(!t)return!1}if(!o&&!t)return!1;if(o&&o._ty_wrap)return!1;try{r[e]=n(o,a)}catch(u){return!1}return r[e]._ty_wrap=[o],!0},mu:function(t,r){var e=arguments,n=dc.URL.match(/^([a-zA-Z]+:)/)[0]+"//"+t+"/"+r+"?av=v1.0.0&v=1.3.0&key="+enc(ty_rum.server.key)+"&ref="+enc(dc.URL)+"&rand="+now();if(e.length>2){var a=e[2];for(var o in a)n+="&"+o+"="+a[o]}return n},gt:function(t,r){function e(){r&&r.apply(this,arguments),n.parentNode&&n.parentNode.removeChild(n)}var n=dc.createElement("script");n.type="text/javascript",n.src=t,ut.sh(n,"readystatechange",function(){("loaded"==n.readyState||4==n.readyState)&&e(null,n.innerHTML)},!1),ut.sh(n,"load",function(){return e(null,n.innerHTML),!0},!1),ut.sh(n,"error",function(){return e("error",n.innerHTML),!0},!1);var a=dc.getElementsByTagName("script")[0];return a.parentNode.insertBefore(n,a)?n:void 0},fpt:function(t,r,e){function n(t,r,e){var n=dc.createElement(t);try{for(var a in r)n[a]=r[a]}catch(o){var u="<"+t;for(var a in r)u+=" "+a+'="'+r[a]+'"';u+=">",e||(u+="</"+t+">"),n=dc.createElement(u)}return n}var a=n("div",{style:"display:none"},!1),o=n("iframe",{name:"_ty_rum_frm",width:0,height:0,style:"display:none"},!1),u=n("form",{style:"display:none",action:t,enctype:"application/x-www-form-urlencoded",method:"post",target:"_ty_rum_frm"},!1),i=n("input",{name:"data",type:"hidden"},!0);return i.value=r,u.appendChild(i),a.appendChild(o),a.appendChild(u),dc.body.appendChild(a),u.submit(),o.onreadystatechange=function(){("complete"===o.readyState||4===o.readyState)&&(e(null,o.innerHTML),dc.body.removeChild(a))},!0},pt:function(t,r,e,n){if(navigator&&navigator.sendBeacon)return navigator.sendBeacon(t,r);if(ut.ie)return ut.fpt(t,r,n);var a;if(wd.XDomainRequest)return a=new XDomainRequest,a.open("POST",t),a.onload=function(){n(null,a.responseText)},ut.sh(a,"load",function(){n(null,a.responseText)},!1),ut.sh(a,"error",function(){n("POST("+t+")error")},!1),ut.wp(!0,a,"onerror",function(t){return function(){return n&&n("post error",a.responseText),!0}}),a.send(r),!0;if(!xr)return!1;a=new xr,a.overrideMimeType&&a.overrideMimeType("text/html");try{a._ty_wrap=1}catch(o){}var u=0;a.onreadystatechange=function(){4==a.readyState&&200==a.status&&(0==u&&n(null,a.responseText),u++)},a.onerror&&ut.wp(!0,a,"onerror",function(t){return function(){return n("post error",a.responseText),"function"==typeof t?t.apply(this,arguments):!0}});try{a.open("POST",t,!0)}catch(o){return ut.fpt(t,r,n)}for(var i in e)a.setRequestHeader(i,e[i]);return a.send(r),!0},sh:function(t,r,e,n){return t.addEventListener?t.addEventListener(r,e,n):t.attachEvent?t.attachEvent("on"+r,e):!1},ag:function(){for(var t=[],r=0;r<arguments.length;r++)t.push(arguments[r]);return t},pj:function(t){if(t&&"string"==typeof t){var r=window.JSON?window.JSON.parse:function(t){return new Function("return "+t)()};return r(t)}return null},trim:trim?function(t){return null==t?"":trim.call(t)}:function(t){return null==t?"":t.toString().replace(/^\s+/,"").replace(/\s+$/,"")}},pf=wd.performance?wd.performance:wd.Performance;pf&&(ut.sh(pf,"resourcetimingbufferfull",function(){var t=pf.getEntriesByType("resource");t&&(ty_rum.ra=ty_rum.ra.concat(t),pf.clearResourceTimings())},!1),ut.sh(pf,"webkitresourcetimingbufferfull",function(){var t=pf.getEntriesByType("resource");t&&(ty_rum.ra=ty_rum.ra.concat(t),pf.webkitClearResourceTimings())},!1));for(var mc=ty_rum.mc={rd:function(){return ty_rum.load_time},ied:function(){function t(){mc.sa()}ty_rum.end_time||(ty_rum.end_time=now(),mc._h=setInterval(t,2e3))},sd:function(){function t(){function t(t){return e[t]>0?e[t]-n:0}var r={};if(pf&&pf.timing){var e=pf.timing;n=e.navigationStart;var a=t("domainLookupStart"),o=t("domainLookupEnd"),u=t("redirectStart"),i=t("redirectEnd"),s=t("connectStart"),c=t("connectEnd");r={f:t("fetchStart"),qs:t("requestStart"),rs:t("responseStart"),re:t("responseEnd"),os:t("domContentLoadedEventStart"),oe:t("domContentLoadedEventEnd"),oi:t("domInteractive"),oc:t("domComplete"),ls:t("loadEventStart"),le:t("loadEventEnd")},c-s>0&&(r.cs=s,r.ce=c),o-a>0&&(r.ds=a,r.de=o),(i-u>0||i>0)&&(r.es=u,r.ee=i),0==r.le&&(r.ue=ty_rum.load_time-n);var m;if(e.msFirstPaint)m=e.msFirstPaint;else if(wd.chrome&&chrome.loadTimes){var d=chrome.loadTimes();d&&d.firstPaintTime&&(m=1e3*d.firstPaintTime)}else ty_rum.fp&&(m=ty_rum.fp);m&&(r.fp=Math.round(m-n)),e.secureConnectionStart&&(r.sl=t("secureConnectionStart"))}else r={t:n,os:ty_rum.end_time-n,ls:ty_rum.load_time-n};r.je=mc.e.length,mc.ct&&(r.ct=mc.ct-n),mc.touch&&(r.fi=mc.touch-n);var f=ty_rum.agent;return f&&(r.id=enc(f.id),r.a=f.a,r.q=f.q,r.tid=enc(f.tid),r.n=enc(f.n)),r}function r(t){var r=window._ty_rum.c_ra;if(t)for(var e=r.length-1;e>=0;e--)if(t.indexOf(r[e].name)>-1)return r[e].xData;return null}function e(t){function e(t){return s[t]>0?s[t]:0}if(t<ty_rum.server.trace_threshold)return null;if(pf&&pf.getEntriesByType){var a={tr:!0,tt:enc(dc.title),charset:dc.characterSet},o=ty_rum.ra,u=pf.getEntriesByType("resource");u&&(o=o.concat(u),pf.webkitClearResourceTimings&&pf.webkitClearResourceTimings(),pf.clearResourceTimings&&pf.clearResourceTimings()),a.res=[];for(var i=0;i<o.length;i++){var s=o[i],c={o:e("startTime"),rt:s.initiatorType,n:s.name,f:e("fetchStart"),ds:e("domainLookupStart"),de:e("domainLookupEnd"),cs:e("connectStart"),ce:e("connectEnd"),sl:e("secureConnectionStart"),qs:e("requestStart"),rs:e("responseStart"),re:e("responseEnd")},m=r(s.name);m&&(c.aid=m.id,c.atd=m.trId,c.an=m.action,c.aq=m.time&&m.time.qu,c.as=m.time&&m.time.duration),a.res.push(c)}if(mc.e.length){a.err=[];for(var i=0,d=mc.e;i<mc.e.length;i++)a.err.push({o:Math.round(d[i][0]-n),e:d[i][1],l:d[i][2],c:d[i][3],r:d[i][4]})}return a}return null}if(mc.sended)return!1;if(!mc.rd())return!1;var n=ty_rum.st,a={},o={};try{o=t(),a=e(o.ls>0?o.ls:ty_rum.load_time-n)}catch(u){}a=a?sf(a):"";var i=ut.mu(ty_rum.server.beacon,"pf",o);if(0!=a.length&&ut.pt(i,a,{},hrs("POST"))||ut.gt(i),mc.e.length>0){var u=mc.e[0];ut.gt(ut.mu(ty_rum.server.beacon_err,"err",{data:enc(sf([u[1],u[2],u[3],"#"==u[4]?dc.URL:u[4],mc.e.length]))}),hrs("GET err"))}return mc.sended=!0,mc.sa(1),!0},sa:function(t){(mc.rd()||t)&&(t||(t=!mc._last_send||now()-mc._last_send>ty_rum.snd_du()||ty_rum.aa.length>=ty_rum.cc()),ty_rum.aa.length>0&&t&&(mc._last_send=now(),ut.pt(ut.mu(ty_rum.server.beacon,"xhr"),sf({xhr:ty_rum.aa}),{},hrs("POST")),ty_rum.aa=[]))},e:[]},ul=null,l=[["load",owl],["beforeunload",owu],["pagehide",owu],["unload",owu],["error",oe]],i=0;i<l.length;i++)ut.sh(wd,l[i][0],l[i][1],!1);l=[["scroll",ot],["keypress",ot],["click",ot],["DOMContentLoaded",odl],["readystatechange",och]];for(var i=0;i<l.length;i++)ut.sh(dc,l[i][0],l[i][1],!1);if(ut.wp(!1,wd,"requestAnimationFrame",function(t){return function(){return ty_rum.fp=now(),wd.requestAnimationFrame=t,t.apply(this,arguments)}}),xr)if(xr.prototype)ut.wp(!1,xr.prototype,"open",wp_open),ut.wp(!1,xr.prototype,"send",wp_send);else{ut.ie=7;var x=xr;wd.XMLHttpRequest=function(){var t=new x;return ut.wp(!1,t,"open",wp_open),ut.wp(!1,t,"send",wp_send),t}}else wd.ActiveXObject&&(ut.ie=6);}}();</script>

	        

</body>
</html>
